<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOVIE QUEST</title>
    <script type="module">
      import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk'
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Georgia', 'Times New Roman', serif;
            overflow: hidden;
        }
        
        #gameContainer {
            position: relative;
            max-width: 100vw;
            max-height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        }
        
        #gameCanvas {
            background: black;
            display: block;
            border-radius: 15px;
            image-rendering: crisp-edges;
        }
        
        #buttonContainer {
            position: absolute;
            left: 50%;
            bottom: 10%;
            transform: translateX(-50%);
            display: none;
            flex-wrap: wrap; /* allow wrapping */
            gap: 12px;
            width: 340px; /* slightly wider to fit two buttons */
            justify-content: center;
        }

        .choice-button {
            flex: 1 1 calc(50% - 12px); /* 2 per row, accounting for gap */
            padding: 12px 10px;
            font-size: 14px;
            font-family: 'Georgia', 'Times New Roman', serif;
            font-weight: 600;
            background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
            color: #d4af37;
            border: 2px solid #d4af37;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.2);
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .choice-button:hover {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
        }

        .choice-button:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(212, 175, 55, 0.3);
        }

        .choice-button.correct-answer {
            animation: correctPulse 0.6s ease-in-out;
        }

        .choice-button.wrong-answer {
            animation: wrongShake 0.6s ease-in-out;
        }

        
        @keyframes correctPulse {
            0% { background: linear-gradient(145deg, #2c2c2c, #1a1a1a); }
            50% { background: linear-gradient(145deg, #27ae60, #1e8449); transform: scale(1.05); }
            100% { background: linear-gradient(145deg, #2c2c2c, #1a1a1a); }
        }
        
        @keyframes wrongShake {
            0% { background: linear-gradient(145deg, #2c2c2c, #1a1a1a); }
            25% { background: linear-gradient(145deg, #e74c3c, #c0392b); transform: translateX(-5px); }
            50% { background: linear-gradient(145deg, #e74c3c, #c0392b); transform: translateX(5px); }
            75% { background: linear-gradient(145deg, #e74c3c, #c0392b); transform: translateX(-5px); }
            100% { background: linear-gradient(145deg, #2c2c2c, #1a1a1a); transform: translateX(0); }
        }
        
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
        }
        
        .message-box {
            background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            color: #d4af37;
            font-size: 28px;
            font-weight: 600;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            border: 2px solid #d4af37;
            transform: scale(0);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 500px;
        }
        
        .message-box.show {
            transform: scale(1);
        }
        
        .message-box h2 {
            margin: 0 0 20px 0;
            font-size: 36px;
        }
        
        .message-box p {
            margin: 10px 0;
            font-size: 20px;
            opacity: 0.8;
        }
        
        .correct {
            background: linear-gradient(145deg, #1a4f3a, #0d2818) !important;
            border-color: #27ae60 !important;
            color: #2ecc71 !important;
        }
        
        .incorrect {
            background: linear-gradient(145deg, #4a1a1a, #2d1010) !important;
            border-color: #e74c3c !important;
            color: #ff6b6b !important;
        }
        
        .rules {
            background: linear-gradient(145deg, #1a2a4a, #0f1a2d) !important;
            border-color: #3498db !important;
            color: #74b9ff !important;
            font-size: 22px;
        }
        
        .temp-message {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(231, 76, 60, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.4);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .temp-message.show {
            opacity: 1;
        }

        .score-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(20, 20, 20, 0.85);
            color: #d4af37;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #d4af37;
            font-family: 'Georgia', 'Times New Roman', serif;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.25);
        }

    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="1000" height="1800"></canvas>
        
        <div id="scoreDisplay" class="score-display">
            Score: <span id="currentScore">0</span>
        </div>
        
        <div id="buttonContainer">
            <button class="choice-button" data-choice="0"></button>
            <button class="choice-button" data-choice="1"></button>
            <button class="choice-button" data-choice="2"></button>
            <button class="choice-button" data-choice="3"></button>
        </div>
        
        <div id="overlay" class="overlay">
            <div id="messageBox" class="message-box">
                <div id="messageText">Welcome to Movie Quest!</div>
            </div>
        </div>
        
        <div id="tempMessage" class="temp-message"></div>
    </div>

    <script>

        // Farcaster SDK initialization
        let isSDKLoaded = false;
        let farcasterContext = null;
        async function initializeFarcasterSDK() {
            if (!isSDKLoaded && typeof sdk !== 'undefined') {
                try {
                    farcasterContext = await sdk.context;
                    console.log('🎯 Farcaster context:', farcasterContext);
                    
                    sdk.actions.ready({});
                    isSDKLoaded = true;
                    
                    return farcasterContext;
                } catch (error) {
                    console.warn('⚠️ Failed to initialize Farcaster SDK:', error);
                    return null;
                }
            }
            return farcasterContext;
        }
        // Initialize SDK when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeFarcasterSDK();
        });


        class MovieGuessingGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.buttonContainer = document.getElementById('buttonContainer');
                this.choiceButtons = document.querySelectorAll('.choice-button');
                this.overlay = document.getElementById('overlay');
                this.messageBox = document.getElementById('messageBox');
                this.messageText = document.getElementById('messageText');
                this.tempMessage = document.getElementById('tempMessage');
                this.scoreDisplay = document.getElementById('currentScore');
                this.remainingAttempts = 1;

                this.currentLevel = 0;
                this.correctButtonIndex = 0;
                this.isGameActive = false;
                this.totalRounds = 20;
                this.buttonsDisabled = false;

                this.timeRemaining = 30;
                this.levelTimer = null;
                this.countdownInterval = null;
                
                // Score system properties
                this.score = 0;
                this.correctAnswers = 0;
                this.failedLevels = 0;
                this.levelStartTime = 0;
                this.levelAttempts = 0;
                
                // Complete movie database with names for all 83 movies
                this.allMovies = [
                  { image: "level/1.jpg", name: "back to the future", challenge: "Easy", alts: ["Bill & Ted’s Excellent Adventure", "The Time Machine", "The Terminator"], clue: "88 mph and a gull-wing car." },
                  { image: "level/2.jpg", name: "gone with the wind", challenge: "Normal", alts: ["The Wizard of Oz", "Casablanca", "The Grapes of Wrath"], clue: "A Southern plantation romance set against the Civil War." },
                  { image: "level/3.jpg", name: "clockwork orange", challenge: "Easy", alts: ["2001: A Space Odyssey", "The Shining", "Brazil"], clue: "Droogs, “milk-plus,” and Beethoven." },
                  { image: "level/4.jpg", name: "departed", challenge: "Normal", alts: ["Goodfellas", "Infernal Affairs", "The Town"], clue: "Boston cops and mobsters with a rat on a balcony." },
                  { image: "level/5.jpg", name: "stand by me", challenge: "Hard", alts: ["The Sandlot", "The Goonies", "Now and Then"], clue: "A trek along railroad tracks to find a body." },
                  { image: "level/6.jpg", name: "lawrence of arabia", challenge: "Normal", alts: ["The Bridge on the River Kwai", "Doctor Zhivago", "The English Patient"], clue: "Mirage heat and a lone figure in white across the desert." },
                  { image: "level/7.jpg", name: "12 angry men", challenge: "Normal", alts: ["Anatomy of a Murder", "The Verdict", "A Few Good Men"], clue: "One room, one jury, one stubborn holdout." },
                  { image: "level/8.jpg", name: "birdman", challenge: "Hard", alts: ["Black Swan", "The Wrestler", "Adaptation"], clue: "A continuous-shot illusion backstage on Broadway." },
                  { image: "level/9.jpg", name: "apocalypse now", challenge: "Normal", alts: ["Platoon", "Full Metal Jacket", "The Deer Hunter"], clue: "Helicopters blasting “Ride of the Valkyries.”" },
                  { image: "level/10.jpg", name: "sixth sense", challenge: "Normal", alts: ["The Others", "Stir of Echoes", "The Ring"], clue: "A child confides, “I see them.”" },
                  { image: "level/11.jpg", name: "some like it hot", challenge: "Hard", alts: ["The Apartment", "Gentlemen Prefer Blondes", "Singin’ in the Rain"], clue: "Two musicians in drag hide from gangsters." },
                  { image: "level/12.jpg", name: "the lives of others", challenge: "Hard", alts: ["The Conversation", "Tinker Tailor Soldier Spy", "Bridge of Spies"], clue: "Stasi wiretaps and a playwright under surveillance." },
                  { image: "level/13.jpg", name: "lalaland", challenge: "Hard", alts: ["The Artist", "Singin’ in the Rain", "Whiplash"], clue: "A jazz pianist and an actress chase dreams in LA." },
                  { image: "level/14.jpg", name: "schindlers list", challenge: "Normal", alts: ["The Pianist", "Life Is Beautiful", "Son of Saul"], clue: "A red coat stands out in a black-and-white world." },
                  { image: "level/15.jpg", name: "everything everywhere all at once", challenge: "Normal", alts: ["The Matrix", "Swiss Army Man", "Doctor Strange"], clue: "A bagel-shaped void and multiverse whiplash." },
                  { image: "level/16.jpg", name: "oppenheimer", challenge: "Easy", alts: ["The Imitation Game", "The Theory of Everything", "Fat Man and Little Boy"], clue: "Manhattan Project genius faces an inquest." },
                  { image: "level/17.jpg", name: "spirited away", challenge: "Easy", alts: ["Howl’s Moving Castle", "My Neighbor Totoro", "Princess Mononoke"], clue: "A bathhouse for spirits and a masked guest." },
                  { image: "level/18.jpg", name: "matrix", challenge: "Easy", alts: ["Dark City", "Equilibrium", "Inception"], clue: "Red pill, blue pill, rain of green code." },
                  { image: "level/19.jpg", name: "ex machina", challenge: "Easy", alts: ["Her", "A.I. Artificial Intelligence", "Blade Runner 2049"], clue: "A Turing test in a secluded glass house." },
                  { image: "level/20.jpg", name: "blade runner", challenge: "Normal", alts: ["Blade Runner 2049", "Ghost in the Shell", "Dark City"], clue: "Neon rain, off-world ads, and replicants." },
                  { image: "level/21.jpg", name: "when harry met sally", challenge: "Normal", alts: ["Sleepless in Seattle", "You’ve Got Mail", "Notting Hill"], clue: "Debating whether friends can stay just friends." },
                  { image: "level/22.jpg", name: "jurassic park", challenge: "Normal", alts: ["The Lost World: Jurassic Park", "King Kong", "Godzilla (1998)"], clue: "Water ripples in a cup before the thunderous step." },
                  { image: "level/23.jpg", name: "top gun", challenge: "Easy", alts: ["Independence day", "Iron Eagle", "Days of Thunder"], clue: "Navy fighter school and a beach volleyball break." },
                  { image: "level/24.jpg", name: "the shining", challenge: "Easy", alts: ["Doctor Sleep", "Rosemary’s Baby", "The Exorcist"], clue: "Overlook Hotel hallways, a tricycle, and Room 237." },
                  { image: "level/25.jpg", name: "et", challenge: "Easy", alts: ["Close Encounters of the Third Kind", "The Iron Giant", "Flight of the Navigator"], clue: "A bike silhouette crossing the moon." },
                  { image: "level/26.jpg", name: "indiana jones", challenge: "Easy", alts: ["The Mummy", "Romancing the Stone", "National Treasure"], clue: "Fedora, bullwhip, and a rolling boulder." },
                  { image: "level/27.jpg", name: "10 things i hate about you", challenge: "Normal", alts: ["Clueless", "She’s All That", "Mean Girls"], clue: "Shakespeare’s “Shrew,” reimagined in high school." },
                  { image: "level/28.jpg", name: "inception", challenge: "Normal", alts: ["Tenet", "The Matrix", "Shutter Island"], clue: "A spinning top that may never fall." },
                  { image: "level/29.jpg", name: "zone of interest", challenge: "Hard", alts: ["Schindler’s List", "The Pianist", "Son of Saul"], clue: "A quiet domestic garden beside an unseen atrocity." },
                  { image: "level/30.jpg", name: "inside out", challenge: "Easy", alts: ["Soul", "Up", "Coco"], clue: "Emotions run HQ inside a kid’s head." },
                  { image: "level/31.jpg", name: "goonies", challenge: "Normal", alts: ["Stand by Me", "The Monster Squad", "Explorers"], clue: "A treasure map to One-Eyed Willy’s riches." },
                  { image: "level/32.jpg", name: "notting hill", challenge: "Hard", alts: ["Four Weddings and a Funeral", "Love Actually", "Bridget Jones’s Diary"], clue: "“I’m just a girl…” in a cozy London bookshop." },
                  { image: "level/33.jpg", name: "ace ventura", challenge: "Easy", alts: ["Dumb and Dumber", "The Mask", "Liar Liar"], clue: "A pet detective hunts a missing dolphin." },
                  { image: "level/34.jpg", name: "rear window", challenge: "Hard", alts: ["Vertigo", "Disturbia", "The Girl on the Train"], clue: "A photographer, a cast, and suspicious neighbors." },
                  { image: "level/35.jpg", name: "guardians of the galaxy", challenge: "Easy", alts: ["Thor: Ragnarok", "Star Trek (2009)", "The Fifth Element"], clue: "A mixtape, a tree, and a very talkative raccoon." },
                  { image: "level/36.jpg", name: "anchorman", challenge: "Easy", alts: ["Talladega Nights", "Step Brothers", "Zoolander"], clue: "“Stay classy,” San Diego evening news." },
                  { image: "level/37.jpg", name: "step brothers", challenge: "Normal", alts: ["The Other Guys", "Dumb and Dumber", "Pineapple Express"], clue: "Two man-children build “more room for activities.”" },
                  { image: "level/38.jpg", name: "arrival", challenge: "Normal", alts: ["Contact", "Interstellar", "Annihilation"], clue: "Heptapod logograms change how time is felt." },
                  { image: "level/39.jpg", name: "wall e", challenge: "Easy", alts: ["The Iron Giant", "Robots", "Big Hero 6"], clue: "A lonely compactor tidies a silent Earth." },
                  { image: "level/40.jpg", name: "the breakfast club", challenge: "Normal", alts: ["Sixteen Candles", "Ferris Bueller’s Day Off", "Dazed and Confused"], clue: "Saturday detention and a group confession." },
                  { image: "level/41.jpg", name: "brazil", challenge: "V. Hard", alts: ["1984", "Twelve Monkeys", "Dark City"], clue: "Ducts, paperwork, and retro-future nightmares." },
                  { image: "level/42.jpg", name: "barbie", challenge: "Easy", alts: ["Enchanted", "Legally Blonde", "The Lego Movie"], clue: "From Dreamhouse perfection to the “real world.”" },
                  { image: "level/43.jpg", name: "braveheart", challenge: "Easy", alts: ["Gladiator", "Kingdom of Heaven", "Rob Roy"], clue: "Blue paint and a cry for freedom." },
                  { image: "level/44.jpg", name: "se7en", challenge: "Normal", alts: ["Zodiac", "The Silence of the Lambs", "Prisoners"], clue: "A serial killer staging the seven deadly sins." },
                  { image: "level/45.jpg", name: "terminator", challenge: "Normal", alts: ["Commando", "RoboCop", "Predator"], clue: "A relentless cyborg hunts a diner waitress." },
                  { image: "level/46.jpg", name: "good will hunting", challenge: "Normal", alts: ["A Beautiful Mind", "Dead Poets Society", "Finding Forrester"], clue: "A janitor solves problems nobody else can." },
                  { image: "level/47.jpg", name: "pan's labyrinth", challenge: "Normal", alts: ["The Devil’s Backbone", "The Orphanage", "The Shape of Water"], clue: "A faun, a chalk door, and a monstrous captain." },
                  { image: "level/48.jpg", name: "point break", challenge: "Normal", alts: ["The Fast and the Furious", "The Town", "Blue Crush"], clue: "Bank robbers in presidential masks, then catch a wave." },
                  { image: "level/49.jpg", name: "truman show", challenge: "Normal", alts: ["Pleasantville", "Eternal Sunshine of the Spotless Mind", "Edtv"], clue: "A man learns his world is a giant set." },
                  { image: "level/50.jpg", name: "silence of the lambs", challenge: "Easy", alts: ["Se7en", "Zodiac", "Manhunter"], clue: "A fava-bean quip from a brilliant cannibal." },
                  { image: "level/51.jpg", name: "the fifth element", challenge: "Normal", alts: ["Valerian and the City of a Thousand Planets", "Jupiter Ascending", "The Hitchhiker’s Guide to the Galaxy"], clue: "“Multipass.” Stones save the world." },
                  { image: "level/52.jpg", name: "american beauty", challenge: "Normal", alts: ["Magnolia", "Revolutionary Road", "The Ice Storm"], clue: "Suburban malaise and a dancing plastic bag." },
                  { image: "level/53.jpg", name: "napoleon dynamite", challenge: "Normal", alts: ["Little Miss Sunshine", "Juno", "Eagle vs Shark"], clue: "“Vote for Pedro” and tetherball." },
                  { image: "level/54.jpg", name: "dune", challenge: "Easy", alts: ["Sandman", "Star Wars", "Blade Runner 2049"], clue: "Sandworms and the spice that must flow." },
                  { image: "level/55.jpg", name: "north by northwest", challenge: "Hard", alts: ["Vertigo", "The 39 Steps", "Charade"], clue: "A crop duster attacks on an empty road." },
                  { image: "level/56.jpg", name: "scent of a woman", challenge: "Hard", alts: ["The Devil’s Advocate", "Any Given Sunday", "The Godfather Part III"], clue: "“Hoo-ah!” and a tango in a restaurant." },
                  { image: "level/57.jpg", name: "dog day afternoon", challenge: "Hard", alts: ["Serpico", "Heat", "Inside Man"], clue: "A sweltering bank siege becomes live TV." },
                  { image: "level/58.jpg", name: "lion king", challenge: "V. Easy", alts: ["Tarzan", "Bambi", "The Jungle Book"], clue: "Pride Rock and the circle of life." },
                  { image: "level/59.jpg", name: "whiplash", challenge: "Normal", alts: ["Black Swan", "Amadeus", "La La Land"], clue: "“Not quite my tempo.”" },
                  { image: "level/60.jpg", name: "coco", challenge: "Normal", alts: ["The Book of Life", "Encanto", "Kubo and the Two Strings"], clue: "A marigold bridge to the Land of the Dead." },
                  { image: "level/61.jpg", name: "the green mile", challenge: "Easy", alts: ["The Shawshank Redemption", "Dead Man Walking", "The Hurricane"], clue: "A gentle giant with a miraculous touch on death row." },
                  { image: "level/62.jpg", name: "reservoir dogs", challenge: "Normal", alts: ["Heat", "The Usual Suspects", "City on Fire"], clue: "Color-coded nicknames after a botched heist." },
                  { image: "level/63.jpg", name: "seven samurai", challenge: "Hard", alts: ["The Magnificent Seven", "Yojimbo", "Ran"], clue: "Villagers hire swords to repel bandits." },
                  { image: "level/64.jpg", name: "princess bride", challenge: "Easy", alts: ["Stardust", "Willow", "Robin Hood: Men in Tights"], clue: "“As you wish.”" },
                  { image: "level/65.jpg", name: "say anything", challenge: "Hard", alts: ["Pretty in Pink", "Sixteen Candles", "Reality Bites"], clue: "A boombox held high under a window." },
                  { image: "level/66.jpg", name: "drive", challenge: "Hard", alts: ["Baby Driver", "The Place Beyond the Pines", "Only God Forgives"], clue: "A scorpion jacket prowls neon-lit LA." },
                  { image: "level/67.jpg", name: "nightcrawler", challenge: "Normal", alts: ["Collateral", "Gone Girl", "The Assistant"], clue: "A freelance stringer chases sirens at 2 a.m." },
                  { image: "level/68.jpg", name: "amelie", challenge: "Normal", alts: ["The Science of Sleep", "Midnight in Paris", "Delicatessen"], clue: "A shy Parisian plots quiet kindnesses." },
                  { image: "level/69.jpg", name: "the big lebowski", challenge: "Easy", alts: ["Fargo", "Inherent Vice", "Burn After Reading"], clue: "A rug that really ties the room together." },
                  { image: "level/70.jpg", name: "citizen kane", challenge: "Hard", alts: ["The Magnificent Ambersons", "Sunset Boulevard", "All the President’s Men"], clue: "Whispers of “Rosebud.”" },
                  { image: "level/71.jpg", name: "fight club", challenge: "Normal", alts: ["American Psycho", "The Machinist", "Se7en"], clue: "Soap, secret rules, and bruised knuckles." },
                  { image: "level/72.jpg", name: "forrest gump", challenge: "Normal", alts: ["The Curious Case of Benjamin Button", "Rain Man", "Big Fish"], clue: "Bench chats and cross-country running." },
                  { image: "level/73.jpg", name: "no country for old men", challenge: "Normal", alts: ["There Will Be Blood", "Sicario", "Hell or High Water"], clue: "A captive bolt pistol and a coin toss." },
                  { image: "level/79.jpg", name: "pulp fiction", challenge: "Normal", alts: ["Reservoir Dogs", "True Romance", "Jackie Brown"], clue: "A glowing briefcase and a diner standoff." },
                  { image: "level/80.jpg", name: "american psycho", challenge: "Normal", alts: ["The Wolf of Wall Street", "The Machinist", "Fight Club"], clue: "A business card showdown before an axe swing." },
                  { image: "level/81.jpg", name: "coming to america", challenge: "Normal", alts: ["Trading Places", "The Nutty Professor", "The Prince & Me"], clue: "An African prince flips burgers in Queens." },
                  { image: "level/82.jpg", name: "indiana jones", challenge: "Normal", alts: ["Uncharted", "National Treasure", "The Mummy"], clue: "Temples, traps, and a golden idol." },
                  { image: "level/83.jpg", name: "matrix", challenge: "Normal", alts: ["The Matrix Reloaded", "Equilibrium", "Ghost in the Shell"], clue: "A lobby shootout with marble columns exploding." },


                  { image: 'level2/81.jpg', name: 'collateral', challenge: 'Normal', alts: ['Heat', 'The Driver', 'Thief'], clue: 'A cab driver becomes hostage to a hitman for one night.' },
                    { image: 'level2/82.jpg', name: 'children of men', challenge: 'Normal', alts: ['Blade Runner 2049', 'The Road', 'Mad Max: Fury Road'], clue: 'Hope carried in a world where no children are born.' },
                    { image: 'level2/83.jpg', name: 'the big short', challenge: 'Normal', alts: ['The Wolf of Wall Street', 'Margin Call', 'Too Big to Fail'], clue: 'Betting against the housing market before the crash.' },
                    { image: 'level2/84.jpg', name: 'spotlight', challenge: 'Normal', alts: ['All the President\'s Men', 'The Post', 'Dark Waters'], clue: 'Investigative journalists uncover institutional cover-ups.' },
                    { image: 'level2/85.jpg', name: 'the master', challenge: 'Normal', alts: ['There Will Be Blood', 'The Talented Mr. Ripley', 'Magnolia'], clue: 'A cult leader and his volatile protégé.' },
                    { image: 'level2/86.jpg', name: 'her', challenge: 'Normal', alts: ['Ex Machina', 'Blade Runner 2049', 'Black Mirror: Be Right Back'], clue: 'Love blooms with an operating system.' },
                    { image: 'level2/87.jpg', name: 'hell or high water', challenge: 'Normal', alts: ['No Country for Old Men', 'Wind River', 'Sicario'], clue: 'Brothers rob banks to save the family ranch.' },
                    { image: 'level2/88.jpg', name: 'scream', challenge: 'Normal', alts: ['Halloween', 'Friday the 13th', 'A Nightmare on Elm Street'], clue: 'A masked killer asks about scary movie rules.' },
                    { image: 'level2/89.jpg', name: 'american psycho', challenge: 'Normal', alts: ['Fight Club', 'The Machinist', 'Nightcrawler'], clue: 'A Wall Street executive\'s morning routine includes murder.' },
                    { image: 'level2/90.jpg', name: 'lost in translation', challenge: 'Normal', alts: ['Before Sunset', 'Her', 'The Virgin Suicides'], clue: 'Two lonely souls connect in Tokyo hotels.' },
                    { image: 'level2/91.jpg', name: 'crouching tiger hidden dragon', challenge: 'Normal', alts: ['Hero', 'House of Flying Daggers', 'The Matrix'], clue: 'Sword fighting that defies gravity in ancient China.' },
                    { image: 'level2/92.jpg', name: '40-year-old virgin', challenge: 'Normal', alts: ['Knocked Up', 'Superbad', 'Anchorman'], clue: 'A man\'s friends help him lose his innocence.' },
                    { image: 'level2/93.jpg', name: 'superbad', challenge: 'Normal', alts: ['Pineapple Express', 'This Is the End', 'Knocked Up'], clue: 'High school friends on a quest for party supplies.' },
                    { image: 'level2/94.jpg', name: 'there will be blood', challenge: 'Normal', alts: ['The Master', 'No Country for Old Men', 'Magnolia'], clue: 'An oil prospector\'s greed consumes everything.' },
                    { image: 'level2/95.jpg', name: 'dumb and dumber', challenge: 'Normal', alts: ['Ace Ventura', 'The Mask', 'Zoolander'], clue: 'Two dimwits road trip to return a briefcase.' },
                    { image: 'level2/96.jpg', name: 'a few good men', challenge: 'Normal', alts: ['The Verdict', 'Twelve Angry Men', 'My Cousin Vinny'], clue: 'A military courtroom drama about handling the truth.' },
                    { image: 'level2/97.jpg', name: 'get out', challenge: 'Normal', alts: ['Us', 'The Stepford Wives', 'Invasion of the Body Snatchers'], clue: 'A weekend getaway reveals sinister family secrets.' },
                    { image: 'level2/98.jpg', name: 'rocky', challenge: 'Normal', alts: ['The Fighter', 'Raging Bull', 'Creed'], clue: 'A small-time boxer gets a shot at the title.' },
                    { image: 'level2/99.jpg', name: 'grand budapest hotel', challenge: 'Normal', alts: ['The Royal Tenenbaums', 'Moonrise Kingdom', 'Fantastic Mr. Fox'], clue: 'A concierge and his protégé in a pink pastry-box hotel.' },
                    { image: 'level2/100.jpg', name: 'magic mike', challenge: 'Normal', alts: ['Step Up', 'Saturday Night Fever', 'Showgirls'], clue: 'A construction worker\'s night job involves choreography.' },
                    { image: 'level2/101.jpg', name: 'avengers endgame', challenge: 'Normal', alts: ['The Dark Knight', 'Justice League', 'X-Men: Days of Future Past'], clue: 'Heroes assemble for a final time-traveling battle.' },
                    { image: 'level2/102.jpg', name: 'the shape of water', challenge: 'Normal', alts: ['Pan\'s Labyrinth', 'The Creature from the Black Lagoon', 'Beauty and the Beast'], clue: 'A mute woman falls for an amphibious creature.' },
                    { image: 'level2/103.jpg', name: 'parasite', challenge: 'Normal', alts: ['Burning', 'The Handmaiden', 'Snowpiercer'], clue: 'A poor family infiltrates a wealthy household.' },
                    { image: 'level2/104.jpg', name: 'memento', challenge: 'Normal', alts: ['Shutter Island', 'The Prestige', 'Inception'], clue: 'A man with no short-term memory hunts his wife\'s killer.' },
                    { image: 'level2/105.jpg', name: 'whiplash', challenge: 'Normal', alts: ['Black Swan', 'La La Land', 'Amadeus'], clue: 'A drummer bleeds for perfection under a brutal conductor.' },
                    { image: 'level2/106.jpg', name: 'gladiator', challenge: 'Normal', alts: ['Braveheart', '300', 'Troy'], clue: 'A Roman general becomes a slave, then a colosseum legend.' },
                    { image: 'level2/107.jpg', name: 'fight club', challenge: 'Normal', alts: ['American Psycho', 'The Machinist', 'Se7en'], clue: 'Underground boxing and soap-making anarchists.' }

                     ];
                
                this.selectedMovies = [];
                this.images = {};
                this.audioContext = null;
                this.sounds = {};
                this.animations = [];
                
                this.init();
            }
            
            //async init() {
                //this.setupCanvas();
                //this.setupEventListeners();
                //this.initAudio();
                //this.selectRandomMovies();
                //await this.preloadAssets();
                //this.showMenu();
                //this.startAnimationLoop();
            //}

            async init() {
                this.setupCanvas();
                this.setupEventListeners();
                this.initAudio();
                this.selectRandomMovies();
                await this.preloadAssets();

                let fidValue = new URLSearchParams(window.location.search).get("fid");

                if (!fidValue) {
                    fidValue = 69;
                    console.warn("⚠ No FID found, continuing without wallet address...");
                    this.fid = fidValue; 
                } else {
                    try {
                        const res = await fetch(`/api/getEthAddress?fid=${fidValue}`);
                        if (res.ok) {
                            const result = await res.json();
                            if (
                                result &&
                                result.users &&
                                result.users.length > 0 &&
                                result.users[0].verified_addresses &&
                                result.users[0].verified_addresses.eth_addresses &&
                                result.users[0].verified_addresses.eth_addresses.length > 0
                            ) {
                                this.playerAddress = result.users[0].verified_addresses.eth_addresses[0];
                                console.log("✅ ETH Address from FID:", this.playerAddress);
                            } else {
                                console.warn("ℹ️ No ETH address linked to FID");
                            }
                        } else {
                            console.error("❌ Failed to fetch ETH address, status", res.status);
                        }
                    } catch (err) {
                        console.error("❌ Error fetching ETH address:", err);
                    }
                }

                this.fid = fidValue; 
                this.showMenu();
                this.startAnimationLoop();
            }




showMenu() {
  const menuOverlay = document.createElement('div');
  menuOverlay.id = 'menuOverlay';
  menuOverlay.style.position = 'fixed';
  menuOverlay.style.top = '0';
  menuOverlay.style.left = '0';
  menuOverlay.style.width = '100%';
  menuOverlay.style.height = '100%';
  menuOverlay.style.background = '#000';
  menuOverlay.style.display = 'flex';
  menuOverlay.style.flexDirection = 'column';
  menuOverlay.style.alignItems = 'center';
  menuOverlay.style.justifyContent = 'center';
  menuOverlay.style.zIndex = '9999';
  menuOverlay.style.gap = '20px';

  const menuImage = document.createElement('img');
  menuImage.src = 'menu.jpg';
  menuImage.alt = 'Game Menu';
  menuImage.style.maxWidth = '90%';
  menuImage.style.maxHeight = '70%';
  menuImage.style.objectFit = 'contain';
  menuImage.style.borderRadius = '12px';
  menuImage.style.boxShadow = '0 4px 16px rgba(0,0,0,0.6)';

  const playBtn = document.createElement('button');
  playBtn.textContent = 'PLAY';
  playBtn.style.padding = '15px 30px';
  playBtn.style.fontSize = '24px';
  playBtn.style.fontWeight = 'bold';
  playBtn.style.backgroundColor = '#d4af37';
  playBtn.style.color = '#141414';
  playBtn.style.border = 'none';
  playBtn.style.borderRadius = '10px';
  playBtn.style.cursor = 'pointer';
  playBtn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.4)';

  // ✅ make callback async so we can await
  playBtn.addEventListener('click', async () => {
    menuOverlay.remove();
    this.showRules();

    // Example: call updateData with fid + damage
 
    await fetch("/api/updateData", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: this.fid, tag: "start"})

    });

  });

  menuOverlay.appendChild(menuImage);
  menuOverlay.appendChild(playBtn);
  document.body.appendChild(menuOverlay);
}

            
            selectRandomMovies() {
                const getRandomSubset = (arr, count) => {
                    const copy = [...arr];
                    const result = [];
                    for (let i = 0; i < count && copy.length > 0; i++) {
                        const randomIndex = Math.floor(Math.random() * copy.length);
                        result.push(copy[randomIndex]);
                        copy.splice(randomIndex, 1);
                    }
                    return result;
                };

                const easyMovies = this.allMovies.filter(m => {
                    const c = m.challenge?.toLowerCase();
                    return c === 'easy' || c === 'v. easy';
                });

                const normalMovies = this.allMovies.filter(m => {
                    const c = m.challenge?.toLowerCase();
                    return c === 'normal';
                });

                const hardMovies = this.allMovies.filter(m => {
                    const c = m.challenge?.toLowerCase();
                    return c === 'hard' || c === 'v. hard';
                });

                const selectedEasy = getRandomSubset(easyMovies, 7);
                const selectedNormal = getRandomSubset(normalMovies, 10);
                const selectedHard = getRandomSubset(hardMovies, 3);

                this.selectedMovies = [...selectedEasy, ...selectedNormal, ...selectedHard]
                    .sort(() => Math.random() - 0.5);

               // console.log('Selected movies:', this.selectedMovies.map(m => m.name));
            }

            
            setupCanvas() {
                const updateCanvasSize = () => {
                    const aspectRatio = 1000 / 1800;
                    
                    let width = Math.min(window.innerWidth * 0.9, 600);
                    let height = width / aspectRatio;
                    
                    if (height > window.innerHeight * 0.9) {
                        height = window.innerHeight * 0.9;
                        width = height * aspectRatio;
                    }
                    
                    this.canvas.style.width = width + 'px';
                    this.canvas.style.height = height + 'px';
                };
                
                updateCanvasSize();
                window.addEventListener('resize', updateCanvasSize);
            }
            
            setupEventListeners() {
                // Add click listeners to all choice buttons
                this.choiceButtons.forEach((button, index) => {
                    button.addEventListener('click', () => this.handleButtonClick(index));
                });
            }
            
            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    this.sounds.correct = new Audio();
                    this.sounds.correct.src = 'soundfx/correct.mp3';
                    this.sounds.correct.onerror = () => console.log('Could not load correct sound');
                    this.sounds.correct.load();
                    
                    this.sounds.wrong = new Audio();
                    this.sounds.wrong.src = 'soundfx/wrong.mp3';
                    this.sounds.wrong.onerror = () => console.log('Could not load wrong sound');
                    this.sounds.wrong.load();
                    
                    this.sounds.select = () => this.playTone(800, 0.1, 'sine');
                    this.sounds.win = () => this.playVictoryFanfare();
                    this.overlayTimer = null;
                    this.confettiTimer = null;
                    
                } catch (e) {
                    console.log('Audio not supported:', e);
                    this.sounds.correct = { play: () => {} };
                    this.sounds.wrong = { play: () => {} };
                    this.sounds.select = () => {};
                    this.sounds.win = () => {};
                }
            }
            
            async preloadAssets() {
                const loadPromises = this.selectedMovies.map((movie) => {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.onload = () => {
                            this.images[movie.image] = img;
                            resolve();
                        };
                        img.onerror = () => {
                            console.warn(`Failed to load ${movie.image}, creating placeholder`);
                            this.createPlaceholderImage(movie);
                            resolve();
                        };
                        img.src = movie.image;
                    });
                });
                
                await Promise.all(loadPromises);
            }

            async startNewGame(resetScores = true) {
                clearTimeout(this.levelTimer);
                clearInterval(this.countdownInterval);
                if (this.overlayTimer) { clearTimeout(this.overlayTimer); this.overlayTimer = null; }
                if (this.confettiTimer) { clearTimeout(this.confettiTimer); this.confettiTimer = null; }

                const badgeOverlay = document.getElementById('badgeOverlay');
                if (badgeOverlay) badgeOverlay.remove();

                this.hideOverlay();

                if (resetScores) {
                    this.score = 0;
                    this.correctAnswers = 0;
                    this.failedLevels = 0;
                    if (this.scoreDisplay) this.scoreDisplay.textContent = '0';
                }

                this.currentLevel = 0;
                this.remainingAttempts = 1;
                this.levelAttempts = 0;
                this.isGameActive = false;
                this.buttonsDisabled = false;

                this.images = {};

                this.selectRandomMovies();
                try {
                    await this.preloadAssets();
                } catch (e) {
                    console.warn('preloadAssets failed (continuing):', e);
                }

                await new Promise(r => setTimeout(r, 120));

                this.isGameActive = true;
                this.drawCurrentLevel();

                setTimeout(() => this.showButtons(), 500);
            }
            
            createPlaceholderImage(movie) {
                const colors = [
                    '#1a237e', '#bf360c', '#263238', '#4a148c', '#b71c1c',
                    '#3e2723', '#0d47a1', '#1b5e20', '#e65100', '#4a148c'
                ];
                
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');
                
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                const gradient = ctx.createLinearGradient(0, 0, 400, 400);
                gradient.addColorStop(0, randomColor);
                gradient.addColorStop(1, this.darkenColor(randomColor, 30));
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 400, 400);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 24px Georgia, serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('IMAGE NOT FOUND', 200, 150);
                
                ctx.font = 'bold 18px Georgia, serif';
                const movieTitle = movie.name.toUpperCase().replace(/\s+/g, '\n');
                const lines = movieTitle.split('\n');
                lines.forEach((line, index) => {
                    ctx.fillText(line, 200, 220 + index * 25);
                });
                
                this.images[movie.image] = canvas;
            }
            
            darkenColor(color, percent) {
                const num = parseInt(color.replace('#', ''), 16);
                const amt = Math.round(2.55 * percent);
                const R = Math.max(0, (num >> 16) - amt);
                const G = Math.max(0, (num >> 8 & 0x00FF) - amt);
                const B = Math.max(0, (num & 0x0000FF) - amt);
                return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
            }
            
            playTone(frequency, duration, type = 'sine') {
                if (!this.audioContext) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = type;
                    
                    gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    console.log('Error playing tone:', e);
                }
            }
            
            playChord(frequencies, duration) {
                frequencies.forEach((freq, index) => {
                    setTimeout(() => this.playTone(freq, duration * 0.8), index * 50);
                });
            }
            
            playVictoryFanfare() {
                const melody = [523, 659, 784, 1047];
                melody.forEach((freq, index) => {
                    setTimeout(() => this.playTone(freq, 0.3), index * 200);
                });
            }
            
            startAnimationLoop() {
                const animate = () => {
                    this.updateAnimations();
                    requestAnimationFrame(animate);
                };
                animate();
            }
            
            updateAnimations() {
                this.animations = this.animations.filter(anim => {
                    anim.update();
                    return !anim.finished;
                });
            }
            
            addAnimation(animation) {
                this.animations.push(animation);
            }
            
            calculateScore(timeToAnswer, attempts, isCorrect) {
                if (!isCorrect) return 0;

                let basePoints = 1000;

                // Base time bonus (still decreases linearly)
                const timeBonus = Math.max(0, Math.floor((30 - timeToAnswer) * 10));

                // Stricter punishment if answer takes more than 5 seconds
                let timePenaltyMultiplier;
                if (timeToAnswer <= 3) {
                    timePenaltyMultiplier = 1.0; // no penalty
                } else if (timeToAnswer <= 10) {
                    timePenaltyMultiplier = 0.8; // mild penalty
                } else if (timeToAnswer <= 20) {
                    timePenaltyMultiplier = 0.6; // heavier penalty
                } else {
                    timePenaltyMultiplier = 0.4; // severe penalty
                }

                // Attempt multiplier (as before)
                const attemptMultiplier = attempts === 1 ? 1.0 : attempts === 2 ? 0.7 : 0.4;

                // Final score calculation
                const levelScore = Math.floor((basePoints + timeBonus) * attemptMultiplier * timePenaltyMultiplier);

                return Math.max(100, levelScore); // never below 100 if correct
            }

            
            updateScore(points) {
                this.score += points;
                this.scoreDisplay.textContent = this.score.toLocaleString();
            }
            
            getFinalGrade() {
                const maxPossibleScore = this.totalRounds * 1300;
                const percentage = (this.score / maxPossibleScore) * 100;
                
                if (percentage >= 90) return 'A+';
                if (percentage >= 80) return 'A';
                if (percentage >= 70) return 'B+';
                if (percentage >= 60) return 'B';
                if (percentage >= 50) return 'C+';
                if (percentage >= 40) return 'C';
                return 'D';
            }
            
            showRules() {
                this.messageBox.className = 'message-box rules';
                this.messageText.innerHTML = `
                    <h2>🎬 Welcome to Movie Quest!</h2>
                    <p>Choose the correct movie name from 4 options</p>
                    <p>20 Random Movies - Good luck! 🍿</p>
                    <p>🏆 Score: Speed + Accuracy = Points!</p>
                `;
                this.showOverlay();
                
                setTimeout(() => {
                    this.hideOverlay();
                    setTimeout(() => this.startGame(), 500);
                }, 3000);
            }
            
            startGame() {
                this.isGameActive = true;
                this.drawCurrentLevel();
                setTimeout(() => this.showButtons(), 1000);
            }
            
            startLevel() {
                this.levelStartTime = Date.now();
                this.levelAttempts = 0;
            }
            
            drawCurrentLevel() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                this.resetLevelTimer();
                this.startLevel();

                const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                gradient.addColorStop(0, '#0f0f0f');
                gradient.addColorStop(1, '#1a1a1a');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.textAlign = "center";
                this.ctx.textBaseline = "middle";


                if (this.currentLevel < this.selectedMovies.length) {
                    const movie = this.selectedMovies[this.currentLevel];
                    const image = this.images[movie.image];
                    
                    if (image) {
                        const canvasWidth = this.canvas.width;
                        const canvasHeight = this.canvas.height;
                        const padding = 40;
                        const availableWidth = canvasWidth - (padding * 2);
                        const availableHeight = canvasHeight * 0.6;

                        let displayWidth, displayHeight, x, y;
                        const originalWidth = image.width || image.naturalWidth;
                        const originalHeight = image.height || image.naturalHeight;
                        const imageAspectRatio = originalWidth / originalHeight;

                        displayWidth = availableWidth;
                        displayHeight = displayWidth / imageAspectRatio;

                        if (displayHeight > availableHeight) {
                            displayHeight = availableHeight;
                            displayWidth = displayHeight * imageAspectRatio;
                        }

                        x = (canvasWidth - displayWidth) / 2;
                        y = 150;

                        this.ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                        this.ctx.shadowOffsetX = 10;
                        this.ctx.shadowOffsetY = 10;
                        this.ctx.shadowBlur = 20;

                        this.ctx.drawImage(image, x, y, displayWidth, displayHeight);

                        this.ctx.shadowColor = 'transparent';

                        this.ctx.fillStyle = '#d4af37';
                        this.ctx.font = 'bold 32px Georgia, serif';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(`Level ${this.currentLevel + 1} of ${this.totalRounds}`, canvasWidth / 2, 70);

                        this.ctx.strokeStyle = '#d4af37';
                        this.ctx.lineWidth = 3;
                        this.ctx.strokeRect(x - 2, y - 2, displayWidth + 4, displayHeight + 4);

                        this.ctx.fillStyle = '#ffffff';
                        this.ctx.font = 'bold 28px Arial';
                        this.ctx.textAlign = 'right';
                        this.ctx.fillText(`⏳ ${this.timeRemaining}s`, canvasWidth - 50, 70);
                    }
                }
                
                // Set up button choices for this level
                this.setupButtonChoices();
            }

            setupButtonChoices() {
                // Randomly choose which button will have the correct answer
                this.correctButtonIndex = Math.floor(Math.random() * 4);

                const currentMovie = this.selectedMovies[this.currentLevel];
                const allChoices = [...currentMovie.alts]; // copy the alternatives
                allChoices.splice(this.correctButtonIndex, 0, currentMovie.name); // insert correct answer at correct index

                // Set button texts from choices array
                this.choiceButtons.forEach((button, index) => {
                    button.textContent = allChoices[index].toUpperCase();
                });

                //console.log(`Level ${this.currentLevel + 1}: Correct answer is button ${this.correctButtonIndex + 1} (${currentMovie.name})`);
            }


            resetLevelTimer() {
                clearTimeout(this.levelTimer);
                clearInterval(this.countdownInterval);

                this.timeRemaining = 30;

                this.countdownInterval = setInterval(() => {
                    this.timeRemaining--;
                    this.updateTimerDisplay();

                    if (this.timeRemaining <= 0) {
                        clearInterval(this.countdownInterval);
                    }
                }, 1000);

                this.levelTimer = setTimeout(() => {
                    clearInterval(this.countdownInterval);
                    this.showTimeOverMessage();
                }, 30000);
            }

            updateTimerDisplay() {
                const canvasWidth = this.canvas.width;
                this.ctx.clearRect(canvasWidth - 200, 40, 200, 50);
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 28px Arial';
                this.ctx.textAlign = 'right';
                this.ctx.fillText(`⏳ ${this.timeRemaining}s`, canvasWidth - 50, 70);
            }

            showTimeOverMessage() {
                this.buttonsDisabled = true;
                this.hideButtons();
                this.failedLevels++;
                this.messageBox.className = 'message-box incorrect';
                this.messageText.innerHTML = `
                    <h2>⏰ Time Over!</h2>
                    <p>You ran out of time for this level.</p>
                    <p>Moving to next level...</p>
                `;
                this.showOverlay();
                
                setTimeout(() => {
                    this.hideOverlay();
                    setTimeout(() => this.nextLevel(), 1000);
                }, 3000);
            }
            
            showButtons() {
                this.buttonContainer.style.display = 'flex';
                this.buttonsDisabled = false;
                
                // Add entrance animation
                this.choiceButtons.forEach((button, index) => {
                    button.style.transform = 'translateY(20px)';
                    button.style.opacity = '0';
                    
                    setTimeout(() => {
                        button.style.transition = 'all 0.3s ease';
                        button.style.transform = 'translateY(0)';
                        button.style.opacity = '1';
                    }, index * 100 + 100);
                });
            }
            
           hideButtons() {
                this.choiceButtons.forEach((button) => {
                    // Animate out
                    button.style.transition = 'all 0.3s ease';
                    button.style.transform = 'translateY(20px)';
                    button.style.opacity = '0';

                    // Reset any leftover highlights
                    button.classList.remove('correct-answer', 'wrong-answer');
                });

                setTimeout(() => {
                    this.buttonContainer.style.display = 'none';
                }, 300);
            }


            handleButtonClick(buttonIndex) {
                if (this.buttonsDisabled || !this.isGameActive) return;

                this.levelAttempts++;
                this.buttonsDisabled = true;

                if (typeof this.sounds.select === 'function') {
                    this.sounds.select();
                }

                // Visual feedback for the clicked button
                const clickedButton = this.choiceButtons[buttonIndex];
                
                if (buttonIndex === this.correctButtonIndex) {
                    // Correct answer
                    clearTimeout(this.levelTimer);
                    clearInterval(this.countdownInterval);

                    clickedButton.classList.add('correct-answer');
                    
                    const timeToAnswer = Math.floor((Date.now() - this.levelStartTime) / 1000);
                    const levelPoints = this.calculateScore(timeToAnswer, this.levelAttempts, true);
                    this.updateScore(levelPoints);
                    this.correctAnswers++;

                    try {
                        this.sounds.correct.play().catch(e => console.log('Could not play correct sound'));
                    } catch (e) {
                        console.log('Error playing correct sound:', e);
                    }

                    setTimeout(() => {
                        clickedButton.classList.remove('correct-answer');
                        this.hideButtons();
                        this.showCorrectMessage(levelPoints);
                    }, 800);
                    
                } else {
                    // Wrong answer
                    this.remainingAttempts--;
                    
                    clickedButton.classList.add('wrong-answer');

                    try {
                        this.sounds.wrong.play().catch(e => console.log('Could not play wrong sound'));
                    } catch (e) {
                        console.log('Error playing wrong sound:', e);
                    }

                    setTimeout(() => {
                        clickedButton.classList.remove('wrong-answer');
                        
                        if (this.remainingAttempts > 0) {
                            this.buttonsDisabled = false;
                            this.showTryAgainMessage();
                        } else {
                            clearTimeout(this.levelTimer);
                            clearInterval(this.countdownInterval);
                            this.failedLevels++;
                            this.hideButtons();
                            this.showIncorrectMessage();
                        }
                    }, 800);
                }
            }

            showTryAgainMessage() {
                this.messageBox.className = 'message-box incorrect';
                this.messageText.innerHTML = `
                    <h2>❌ Incorrect!</h2>
                    <p>You have ${this.remainingAttempts} ${this.remainingAttempts === 1 ? 'chance' : 'chances'} left.</p>
                `;
                this.showOverlay();
                setTimeout(() => {
                    this.hideOverlay();
                }, 2000);
            }

            showCorrectMessage(points) {
                this.messageBox.className = 'message-box correct';
                this.messageText.innerHTML = `
                    <h2>🎉 Correct!</h2>
                    <p>+${points} points!</p>
                    <p>Well done! Moving to next level...</p>
                `;
                this.showOverlay();
                
                setTimeout(() => {
                    this.hideOverlay();
                    setTimeout(() => this.nextLevel(), 400);
                }, 2000);
            }

            showIncorrectMessage() {
                const correctAnswer = this.selectedMovies[this.currentLevel].name.toUpperCase();
                this.messageBox.className = 'message-box incorrect';
                this.messageText.innerHTML = `
                    <h2>❌ Out of attempts!</h2>
                    <p>Moving to next level...</p>
                `;
                this.showOverlay();
                
                setTimeout(() => {
                    this.hideOverlay();
                    setTimeout(() => this.nextLevel(), 400);
                }, 4000);
            }

            nextLevel() {
                this.currentLevel++;
                this.remainingAttempts = 1;
                
                if (this.currentLevel >= 1) {
                    this.showGameComplete();
                } else {
                    this.drawCurrentLevel();
                    setTimeout(() => this.showButtons(), 100);
                }
            }
            
            showGameComplete() {
                if (typeof this.sounds.win === 'function') {
                    this.sounds.win();
                }
                
                const accuracy = Math.round((this.correctAnswers / this.totalRounds) * 100);
                const grade = this.getFinalGrade();
                
                this.messageBox.className = 'message-box correct';
                this.messageText.innerHTML = `
                    <h2>🏆 Game Complete!</h2>
                    <p>Final Score: <strong>${this.score.toLocaleString()}</strong></p>
                    <p>Correct: ${this.correctAnswers}/${this.totalRounds} (${accuracy}%)</p>
                    <p>Failed Levels: ${this.failedLevels}</p>
                    <p>Grade: <strong>${grade}</strong></p>
                    <button id="continueBtn" style="
                        margin-top: 20px;
                        padding: 10px 18px;
                        background-color: #d4af37;
                        border: none;
                        border-radius: 8px;
                        color: #141414;
                        font-weight: bold;
                        cursor: pointer;
                        font-size: 16px;
                    ">
                        Continue
                    </button>
                `;
                
                this.showOverlay();
                this.isGameActive = false;
                this.addConfettiEffect();

                const btn = document.getElementById('continueBtn');
                if (btn) {
                    btn.addEventListener('click', (ev) => {
                        ev.preventDefault();
                        this.showBadge(grade);
                        await fetch("/api/updateData", {
                          method: "POST",
                          headers: { "Content-Type": "application/json" },
                          body: JSON.stringify({ id: this.fid, tag: "end"})

                        });
                    }, { once: true });
                }
            }

showBadge(grade) {
    if (!grade) grade = 'unknown';
    const badgePath = `badges/${grade.toLowerCase()}.png`;

    const existingOverlay = document.getElementById('badgeOverlay');
    if (existingOverlay) existingOverlay.remove();

    const overlay = document.createElement('div');
overlay.id = 'badgeOverlay';
overlay.style.position = 'fixed';
overlay.style.top = '0';
overlay.style.left = '0';
overlay.style.width = '100vw';
overlay.style.height = '100vh';
overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
overlay.style.display = 'flex';
overlay.style.flexDirection = 'column';
overlay.style.justifyContent = 'center'; // centers vertically
overlay.style.alignItems = 'center';    // centers horizontally
overlay.style.zIndex = '999999';
overlay.style.color = 'white';
overlay.style.textAlign = 'center';
overlay.style.padding = '20px';

const title = document.createElement('h2');
title.textContent = '🎖️ You Earned a Badge!';
// push down from the top (margin-top = 20px), keep small gap below (10px)
title.style.margin = '20px 0 3px -30px'; 
overlay.appendChild(title);

const badgeImg = document.createElement('img');
badgeImg.src = badgePath;
badgeImg.alt = `${grade} Badge`;
badgeImg.style.maxWidth = '80vw';
badgeImg.style.maxHeight = '50vh';
// small bottom space before grade text
badgeImg.style.margin = '0 0 -5px -30px'; 
overlay.appendChild(badgeImg);

const gradeText = document.createElement('p');
gradeText.innerHTML = `Grade: <strong>${grade}</strong>`;
// slightly upward pull, but less extreme
gradeText.style.margin = '-20px 0 0 -30px'; 
overlay.appendChild(gradeText);



    const btnContainer = document.createElement('div');
    btnContainer.style.display = 'flex';
    btnContainer.style.gap = '15px';
    btnContainer.style.marginTop = '20px';
    btnContainer.style.flexWrap = 'wrap';
    btnContainer.style.justifyContent = 'center';
    btnContainer.style.marginLeft = '-30px';

    const mintBtn = document.createElement('button');
    mintBtn.textContent = 'Mint';
    mintBtn.style.padding = '12px 24px';
    mintBtn.style.backgroundColor = '#28a745';
    mintBtn.style.color = '#fff';
    mintBtn.style.border = 'none';
    mintBtn.style.borderRadius = '8px';
    mintBtn.style.fontSize = '16px';
    mintBtn.style.cursor = 'pointer';

    mintBtn.onclick = async () => {
        const walletAddress = this.playerAddress || '0x52e9e3e548eA38E55bB32cD5f5E8cb7db6D062F3';
        const grade = this.getFinalGrade();
        const gradeToTokenId = {
            "A+": 5,
            "A": 4,
            "B+": 3,
            "B": 2,
            "C+": 1,
            "C": 1,
            "D": 0
        };
        const tokenId = gradeToTokenId[grade] ?? 0;

        mintBtn.disabled = true;
        mintBtn.textContent = 'Minting... ⏳';

        try {
            const res = await fetch('https://test-mint-stuff.vercel.app/api/mint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    address: walletAddress, 
                    tokenId,
                    quantity: 1 
                })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                badgeImg.style.display = 'none';
                mintBtn.style.display = 'none';
                title.textContent = '✅ Mint Successful!';
                title.style.marginBottom = '15px'; // tiny space below title

                gradeText.innerHTML = `<p style="font-size:11px; text-align:center; margin-top:4px;">Wallet: ${walletAddress}</p>`;

            } else {
                badgeImg.style.display = 'none';
                mintBtn.style.display = 'none';
                title.textContent = '❌ Mint Failed!';
                gradeText.innerHTML = `<p>${err.message}</p>`;
            }

        } catch (err) {
            console.error(err);
            this.messageBox.className = 'message-box incorrect';
            this.messageText.innerHTML = `
                <h2>❌ Mint Failed!</h2>
                <p>${err.message}</p>
            `;
            this.showOverlay();
        } finally {
            if (mintBtn.style.display !== 'none') {
                mintBtn.disabled = false;
                mintBtn.textContent = 'Mint';
            }
        }
    };

    const restartBtn = document.createElement('button');
    restartBtn.textContent = 'Restart';
    restartBtn.style.padding = '12px 24px';
    restartBtn.style.backgroundColor = '#d4af37';
    restartBtn.style.color = '#141414';
    restartBtn.style.border = 'none';
    restartBtn.style.borderRadius = '8px';
    restartBtn.style.fontSize = '16px';
    restartBtn.style.cursor = 'pointer';

    restartBtn.onclick = async () => {
        restartBtn.disabled = true;
        await this.startNewGame(true);
        overlay.remove();
    };

    btnContainer.appendChild(mintBtn);
    btnContainer.appendChild(restartBtn);
    overlay.appendChild(btnContainer);

    document.body.appendChild(overlay);
} // ✅ this closes showBadge correctly





            
            addConfettiEffect() {
                const colors = ['#d4af37', '#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1'];
                
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.style.position = 'absolute';
                        confetti.style.width = '10px';
                        confetti.style.height = '10px';
                        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.left = Math.random() * 100 + '%';
                        confetti.style.top = '-10px';
                        confetti.style.borderRadius = '50%';
                        confetti.style.pointerEvents = 'none';
                        confetti.style.zIndex = '1001';
                        
                        document.getElementById('gameContainer').appendChild(confetti);
                        
                        confetti.style.transition = 'all 3s ease-in';
                        setTimeout(() => {
                            confetti.style.transform = `translateY(${window.innerHeight + 20}px) rotate(720deg)`;
                            confetti.style.opacity = '0';
                        }, 100);
                        
                        setTimeout(() => {
                            confetti.remove();
                        }, 3200);
                    }, i * 100);
                }
            }
            
            showOverlay() {
                this.overlay.style.display = 'flex';
                setTimeout(() => {
                    this.messageBox.classList.add('show');
                }, 100);
            }
            
            hideOverlay() {
                this.messageBox.classList.remove('show');
                setTimeout(() => {
                    this.overlay.style.display = 'none';
                }, 400);
            }
            
            showTemporaryMessage(message) {
                this.tempMessage.textContent = message;
                this.tempMessage.classList.add('show');
                
                setTimeout(() => {
                    this.tempMessage.classList.remove('show');
                }, 2000);
            }
        }

        // Global shareToFarcaster function (outside showBadge)
        window.shareToFarcaster = async function (grade, accuracy) {
          try {
            await initializeFarcasterSDK(); // make sure SDK is ready

            const text = `🎬 I scored ${grade} (${accuracy}% correct) in Movie QUEST!`;
            const gameUrl = "https://cinema-quest-eosin.vercel.app/";

            sdk.actions.composeCast({
              text,
              embeds: [gameUrl],
            });
          } catch (error) {
            console.warn("⚠️ Farcaster SDK share failed, using Warpcast fallback:", error);

            const baseUrl = "https://warpcast.com/~/compose";
            const text = `🎬 I scored ${grade} (${accuracy}% correct) in Movie QUEST!`;
            const gameUrl = "https://cinema-quest-eosin.vercel.app/";

            const shareUrl =
              baseUrl +
              "?text=" +
              encodeURIComponent(text) +
              "&embeds[]=" +
              encodeURIComponent(gameUrl);

            const popup = window.open(shareUrl, "_blank", "width=600,height=700");
            if (!popup || popup.closed || typeof popup.closed === "undefined") {
              window.location.href = shareUrl;
            }
          }
        };
        
        // Start the game when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.game = new MovieGuessingGame();
        });



        
        // Enable audio context on first user interaction (required by browsers)
        document.addEventListener('click', function enableAudio() {
            if (window.game && window.game.audioContext && window.game.audioContext.state === 'suspended') {
                window.game.audioContext.resume();
            }
        }, { once: true });
    </script>


</body>
</html>